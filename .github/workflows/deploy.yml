name: Deploy Store Manager Labo 03

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Nettoyage avant checkout
      run: |
        sudo chown -R $USER:$USER . || true
        docker system prune -f 

    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Vérifier les fichiers requis
      run: |
        if [ ! -f "init.sql" ]; then
          echo "ERREUR: Le fichier init.sql est manquant!"
          ls -la
          exit 1
        fi
        echo "✓ init.sql trouvé"
        
        if [ ! -f "docker-compose.yml" ]; then
          echo "ERREUR: Le fichier docker-compose.yml est manquant!"
          exit 1
        fi
        echo "✓ docker-compose.yml trouvé"
    
    - name: Arrêter les services existants
      run: |
        docker compose down -v || true
        # S'assurer que le volume MySQL est complètement supprimé
        docker volume rm log430-labo3_mysql_data 2>/dev/null || true
        docker volume prune -f
        # Nettoyer aussi le réseau s'il existe
        docker network rm labo03-network 2>/dev/null || true
    
    - name: Build et démarrage des services
      run: |
        echo "Démarrage de docker compose..."
        docker compose up -d --build
        
        echo "Attente de 10 secondes pour le démarrage initial..."
        sleep 10
        
        echo "=== État des containers ==="
        docker ps -a
        
        echo ""
        echo "=== Vérification MySQL ==="
        if docker ps | grep -q mysql; then
          echo "✓ MySQL est en cours d'exécution"
        else
          echo "✗ MySQL n'est pas en cours d'exécution!"
          echo ""
          echo "--- Logs complets MySQL ---"
          docker logs mysql 2>&1 || echo "Impossible de récupérer les logs"
          echo ""
          echo "--- Inspection du container ---"
          docker inspect mysql 2>&1 | grep -A 10 "State" || echo "Inspection impossible"
          exit 1
        fi
        
        echo ""
        echo "=== Vérification Redis ==="
        if docker ps | grep -q redis; then
          echo "✓ Redis est en cours d'exécution"
        else
          echo "✗ Redis n'est pas en cours d'exécution!"
          docker logs redis 2>&1 || echo "Impossible de récupérer les logs"
          exit 1
        fi

    - name: Attendre que les services soient prêts
      run: |
        echo "Attente des services (healthchecks)..."
        
        # Attendre que MySQL soit healthy
        MAX_WAIT=180
        ELAPSED=0
        echo "Attente de MySQL..."
        until [ "$(docker inspect --format='{{.State.Health.Status}}' mysql 2>/dev/null)" = "healthy" ]; do
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "ERREUR: MySQL n'est pas devenu healthy après ${MAX_WAIT}s"
            echo "--- Logs MySQL ---"
            docker logs mysql --tail 50
            exit 1
          fi
          echo "MySQL status: $(docker inspect --format='{{.State.Health.Status}}' mysql 2>/dev/null || echo 'starting...')"
          sleep 5
          ELAPSED=$((ELAPSED + 5))
        done
        echo "✓ MySQL est prêt!"
        
        # Attendre que Redis soit healthy
        echo "Attente de Redis..."
        ELAPSED=0
        until [ "$(docker inspect --format='{{.State.Health.Status}}' redis 2>/dev/null)" = "healthy" ]; do
          if [ $ELAPSED -ge 60 ]; then
            echo "ERREUR: Redis n'est pas devenu healthy après 60s"
            docker logs redis --tail 50
            exit 1
          fi
          echo "Redis status: $(docker inspect --format='{{.State.Health.Status}}' redis 2>/dev/null || echo 'starting...')"
          sleep 3
          ELAPSED=$((ELAPSED + 3))
        done
        echo "✓ Redis est prêt!"
        
        # Vérifier que la table stocks existe
        echo "Vérification de la table stocks..."
        if docker exec mysql mysql -u labo03 -plabo03 labo03_db -e "DESCRIBE stocks;" > /dev/null 2>&1; then
          echo "✓ Table stocks trouvée!"
          docker exec mysql mysql -u labo03 -plabo03 labo03_db -e "SELECT COUNT(*) as stock_count FROM stocks;"
        else
          echo "ERREUR: Table stocks non trouvée"
          echo "--- Tables disponibles ---"
          docker exec mysql mysql -u labo03 -plabo03 labo03_db -e "SHOW TABLES;"
          exit 1
        fi

    - name: Synchronisation initiale des stocks (Activité 5)
      run: |
        echo "Synchronisation Redis depuis MySQL..."
        docker exec store_manager python -c "from db import get_redis_conn; from stocks.commands.write_stock import _populate_redis_from_mysql; r = get_redis_conn(); _populate_redis_from_mysql(r)"
        echo "✓ Stocks synchronisés!"
    
    - name: Exécuter les tests unitaires
      run: |
        echo "Exécution des tests..."
        docker exec store_manager pytest -v
        echo "✓ Tests terminés!"

    - name: Afficher le statut des services
      if: success()
      run: |
        echo "=== Déploiement réussi! ==="
        echo ""
        echo "Services actifs:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        echo ""
        echo "Santé des services:"
        echo "MySQL: $(docker inspect --format='{{.State.Health.Status}}' mysql)"
        echo "Redis: $(docker inspect --format='{{.State.Health.Status}}' redis)"

    - name: Nettoyage post-déploiement
      if: always()
      run: |
        docker image prune -f 
        sudo chown -R $USER:$USER .